<div class="pet-profile-bg py-5">
  <div class="container">

    <div class="row mb-5">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
          <div class="flex-grow-1">
            <h1 class="display-5 fw-bold text-primary mb-2">
              <i class="bi bi-heart-pulse me-3"></i>
              Pet Profiles
            </h1>
            <p class="text-muted fs-5 mb-3">Manage your beloved pets and view their medical history</p>
          </div>
          <!-- Desktop button (hidden on small screens) -->
          <button class="btn btn-primary btn-lg d-none d-md-inline-block pt-2 pb-2" (click)="openAddPetModal()">
            <i class="bi bi-plus-circle me-2"></i>
            Add New Pet
          </button>
          <!-- Mobile button placed after text -->
          <div class="w-100 d-md-none"></div>
          <button class="btn btn-primary w-100 d-md-none" (click)="openAddPetModal()">
            <i class="bi bi-plus-circle me-2"></i>
            Add New Pet
          </button>
        </div>
      </div>
    </div>


    <div *ngIf="isLoadingPets" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading pets...</span>
      </div>
      <p class="mt-3 text-muted">Loading your pets...</p>
    </div>


    <div *ngIf="!isLoadingPets">
      
      <div *ngIf="pets.length === 0" class="text-center py-5">
        <div class="empty-state">
          <i class="bi bi-heart display-1 text-muted mb-4"></i>
          <h3 class="text-muted mb-3">No pets yet</h3>
          <p class="text-muted mb-4">Start by adding your first pet to track their health and appointments.</p>
          <button class="btn btn-primary btn-lg" (click)="openAddPetModal()">
            <i class="bi bi-plus-circle me-2"></i>
            Add Your First Pet
          </button>
        </div>
      </div>

      
      <div *ngIf="pets.length > 0" class="row g-4 mb-5">
        <div class="col-lg-4 col-md-6" *ngFor="let pet of pets">
          <div class="pet-card">
            <div class="pet-card-header">
              <div class="pet-avatar">
                <i class="bi bi-heart-fill"></i>
              </div>
              <div class="pet-info">
                <h4 class="pet-name">{{ pet.name }}</h4>
                <p class="pet-type">{{ pet.type }} â€¢ {{ pet.breed }}</p>
              </div>
              <div class="pet-actions">
                <button class="btn btn-outline-primary btn-sm" (click)="startEdit(pet)" title="Edit Pet">
                  <i class="bi bi-pencil"></i>
                </button>
              </div>
            </div>
            <div class="pet-card-body">
              <div class="pet-details">
                <div class="detail-item">
                  <span class="label"><i class="bi bi-calendar me-2"></i>Age:</span>
                  <span class="value">{{ pet.age }} years</span>
                </div>
                <div class="detail-item">
                  <span class="label"><i class="bi bi-person me-2"></i>Owner:</span>
                  <span class="value">{{ pet.owner }}</span>
                </div>
              </div>
              
  
              <div class="medical-history-preview">
                <h6 class="section-title">
                  <i class="bi bi-clipboard2-pulse me-2"></i>
                  Recent Medical History
                </h6>
                <div *ngIf="getPetMedicalHistory(pet.name).length === 0" class="no-history">
                  <p class="text-muted small">No medical records yet</p>
                </div>
                <div *ngIf="getPetMedicalHistory(pet.name).length > 0" class="history-list">
                  <div class="history-item" *ngFor="let record of getPetMedicalHistory(pet.name).slice(0, 2)">
                    <div class="history-date">{{ formatDate(record.date) }}</div>
                    <div class="history-details">
                      <div class="history-doctor">Dr. {{ record.docname }}</div>
                      <div class="history-type">{{ record.appointmentType || 'General Checkup' }}</div>
                    </div>
                  </div>
                  <div *ngIf="getPetMedicalHistory(pet.name).length > 2" class="more-history">
                    <small class="text-muted">+{{ getPetMedicalHistory(pet.name).length - 2 }} more records</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <div *ngIf="!isLoadingHistory && medicalHistory.length > 0" class="row">
      <div class="col-12">
        <div class="medical-history-section">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="section-header">
              <i class="bi bi-clipboard2-pulse me-3"></i>
              Complete Medical History
            </h2>
            <button class="btn btn-outline-primary btn-sm" (click)="refreshMedicalHistory()" [disabled]="isLoadingHistory">
              <i class="bi bi-arrow-clockwise me-2"></i>
              Refresh
            </button>
          </div>
          
          <div class="medical-records">
            <div class="medical-record" *ngFor="let record of medicalHistory">
              <div class="record-header">
                <div class="record-date">
                  <div class="date-day">{{ formatDate(record.date) }}</div>
                  <div class="date-time">{{ formatTime(record.time) }}</div>
                </div>
                <div class="record-pet">
                  <h5 class="pet-name">{{ record.petname }}</h5>
                  <div class="pet-details">
                    <span class="breed" *ngIf="record.petBreed">{{ record.petBreed }}</span>
                    <span class="age" *ngIf="record.petAge">{{ record.petAge }} years</span>
                  </div>
                </div>
                <div class="record-doctor">
                  <div class="doctor-name">Dr. {{ record.docname }}</div>
                  <div class="appointment-type">{{ record.appointmentType || 'General Checkup' }}</div>
                </div>
                <div class="record-status">
                  <span class="badge bg-success">Completed</span>
                </div>
              </div>
              <div class="record-body" *ngIf="record.notes || record.reasonForVisit">
                <div class="record-section" *ngIf="record.reasonForVisit">
                  <h6 class="section-title">Reason for Visit</h6>
                  <p class="section-content">{{ record.reasonForVisit }}</p>
                </div>
                <div class="record-section" *ngIf="record.notes">
                  <h6 class="section-title">Notes & Treatment</h6>
                  <p class="section-content">{{ record.notes }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    
    <div *ngIf="isLoadingHistory" class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading medical history...</span>
      </div>
      <p class="mt-3 text-muted">Loading medical history...</p>
    </div>

    
    <div *ngIf="!isLoadingHistory && medicalHistory.length === 0" class="row">
      <div class="col-12">
        <div class="medical-history-section">
          <div class="text-center py-5">
            <i class="bi bi-clipboard2-pulse display-1 text-muted mb-3"></i>
            <h4 class="text-muted">No Medical History Available</h4>
            <p class="text-muted mb-4">
              Your completed appointments will appear here as medical history records.
            </p>
            <button class="btn btn-outline-primary" (click)="refreshMedicalHistory()">
              <i class="bi bi-arrow-clockwise me-2"></i>
              Refresh Medical History
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="addPetModal" tabindex="-1" aria-labelledby="addPetModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form (ngSubmit)="addPet()">
        <div class="modal-header">
          <h5 class="modal-title" id="addPetModalLabel">
            <i class="bi bi-plus-circle me-2"></i>
            Add New Pet
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" (click)="closeAddPetModal()"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Name</label>
              <input class="form-control" [(ngModel)]="newPet.name" name="name" required />
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Species</label>
              <select class="form-select" [(ngModel)]="newPet.type" name="type" required (change)="onSpeciesChange()">
                <option value="">Select Species</option>
                <option *ngFor="let species of speciesOptions" [value]="species">{{ species }}</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Breed</label>
              <select class="form-select" [(ngModel)]="newPet.breed" name="breed" required [disabled]="!newPet.type">
                <option value="">Select Breed</option>
                <option *ngFor="let breed of getAvailableBreeds(newPet.type)" [value]="breed">{{ breed }}</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Age</label>
              <input type="number" class="form-control" [(ngModel)]="newPet.age" name="age" required min="0" max="30" />
            </div>
            <div class="col-12 mb-3">
              <label class="form-label">Owner</label>
              <input class="form-control" [(ngModel)]="newPet.owner" name="owner" readonly 
                     title="Owner is automatically set to your email address" />
              <small class="form-text text-muted">Owner is automatically set to your email address</small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Add Pet</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" (click)="closeAddPetModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>


<div class="modal fade" id="editPetModal" tabindex="-1" aria-labelledby="editPetModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form (ngSubmit)="saveEdit()">
        <div class="modal-header">
          <h5 class="modal-title" id="editPetModalLabel">
            <i class="bi bi-pencil-square me-2"></i>
            Edit Pet
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" (click)="cancelEdit()"></button>
        </div>
        <div class="modal-body" *ngIf="selectedPet">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Name</label>
              <input class="form-control" [(ngModel)]="selectedPet.name" name="edit_name" required />
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Species</label>
              <select class="form-select" [(ngModel)]="selectedPet.type" name="edit_type" required (change)="onEditSpeciesChange()">
                <option value="">Select Species</option>
                <option *ngFor="let species of speciesOptions" [value]="species">{{ species }}</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Breed</label>
              <select class="form-select" [(ngModel)]="selectedPet.breed" name="edit_breed" required [disabled]="!selectedPet.type">
                <option value="">Select Breed</option>
                <option *ngFor="let breed of getAvailableBreeds(selectedPet.type)" [value]="breed">{{ breed }}</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Age</label>
              <input type="number" class="form-control" [(ngModel)]="selectedPet.age" name="edit_age" required min="0" max="30" />
            </div>
            <div class="col-12 mb-3">
              <label class="form-label">Owner</label>
              <input class="form-control" [(ngModel)]="selectedPet.owner" name="edit_owner" readonly 
                     title="Owner cannot be changed" />
              <small class="form-text text-muted">Owner cannot be changed</small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" (click)="cancelEdit()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>
