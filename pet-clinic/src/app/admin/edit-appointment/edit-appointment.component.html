<div class="container mt-4">
  <h2 class="mb-4">
    <i class="bi bi-pencil me-2"></i>
    Edit Appointment
    <small class="text-muted" *ngIf="appointment"> - ID: #{{ appointment.id }}</small>
  </h2>

  <div *ngIf="isLoading" class="text-center">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading appointment details...</p>
  </div>

  <div *ngIf="!isLoading && appointment">

    <div *ngIf="appointment.status !== 'pending'" class="alert alert-warning" role="alert">
      <i class="bi bi-exclamation-triangle me-2"></i>
      <strong>Note:</strong> This appointment is currently <strong>{{ appointment.status | titlecase }}</strong>. 
      Only pending appointments can be edited. You can view the details but cannot modify them.
    </div>

    <form #editFormRef="ngForm" (ngSubmit)="updateAppointment()">
      <div class="row g-3">

        <div class="col-md-6">
          <label for="date" class="form-label">Date *</label>
          <input 
            type="date" 
            id="date" 
            class="form-control" 
            [(ngModel)]="editForm.date" 
            name="date"
            [disabled]="!canEditAppointment(appointment)"
            required>
        </div>
        <div class="col-md-6">
          <label for="time" class="form-label">Time *</label>
          <input 
            type="time" 
            id="time" 
            class="form-control" 
            [(ngModel)]="editForm.time" 
            name="time"
            [disabled]="!canEditAppointment(appointment)"
            required>
        </div>


        <div class="col-md-6">
          <label for="petname" class="form-label">Pet Name *</label>
          <input 
            type="text" 
            id="petname" 
            class="form-control" 
            [(ngModel)]="editForm.petname" 
            name="petname"
            [disabled]="!canEditAppointment(appointment)"
            required>
        </div>
        <div class="col-md-3">
          <label for="petAge" class="form-label">Pet Age</label>
          <input 
            type="text" 
            id="petAge" 
            class="form-control" 
            [(ngModel)]="editForm.petAge" 
            name="petAge"
            [disabled]="!canEditAppointment(appointment)"
            placeholder="e.g., 2 years">
        </div>
        <div class="col-md-3">
          <label for="petBreed" class="form-label">Pet Breed</label>
          <input 
            type="text" 
            id="petBreed" 
            class="form-control" 
            [(ngModel)]="editForm.petBreed" 
            name="petBreed"
            [disabled]="!canEditAppointment(appointment)"
            placeholder="e.g., Golden Retriever">
        </div>

        <div class="col-md-6">
          <label for="name" class="form-label">Owner Name *</label>
          <input 
            type="text" 
            id="name" 
            class="form-control" 
            [(ngModel)]="editForm.name" 
            name="name"
            [disabled]="!canEditAppointment(appointment)"
            required>
        </div>
        <div class="col-md-6">
          <label for="email" class="form-label">Owner Email *</label>
          <input 
            type="email" 
            id="email" 
            class="form-control" 
            [(ngModel)]="editForm.email" 
            name="email"
            [disabled]="!canEditAppointment(appointment)"
            required>
        </div>
        <div class="col-md-6">
          <label for="contactNumber" class="form-label">Contact Number</label>
          <input 
            type="tel" 
            id="contactNumber" 
            class="form-control" 
            [(ngModel)]="editForm.contactNumber" 
            name="contactNumber"
            [disabled]="!canEditAppointment(appointment)">
        </div>

        <div class="col-md-6">
          <label for="docname" class="form-label">Doctor *</label>
          <select 
            id="docname" 
            class="form-select" 
            [(ngModel)]="editForm.docname" 
            name="docname"
            (change)="onDoctorSelected($event)"
            [disabled]="!canEditAppointment(appointment)"
            required>
            <option value="">Select Doctor</option>
            <option *ngFor="let doctor of doctors" [value]="doctor.dname">
              {{ doctor.dname }} - {{ doctor.specialization }}
            </option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="appointmentType" class="form-label">Appointment Type</label>
          <select 
            id="appointmentType" 
            class="form-select" 
            [(ngModel)]="editForm.appointmentType" 
            name="appointmentType"
            (change)="onServiceSelected($event)"
            [disabled]="!canEditAppointment(appointment)">
            <option value="">Select Service</option>
            <option *ngFor="let service of services" [value]="service.name">
                              {{ service.name }} - Rs.{{ service.price }}
            </option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="status" class="form-label">Status *</label>
          <select 
            id="status" 
            class="form-select" 
            [(ngModel)]="editForm.status" 
            name="status"
            [disabled]="!canEditAppointment(appointment)"
            required>
            <option *ngFor="let status of statusOptions" [value]="status">
              {{ status | titlecase }}
            </option>
          </select>
        </div>

        <div class="col-12">
          <label for="reasonForVisit" class="form-label">Reason for Visit</label>
          <input 
            type="text" 
            id="reasonForVisit" 
            class="form-control" 
            [(ngModel)]="editForm.reasonForVisit" 
            name="reasonForVisit"
            [disabled]="!canEditAppointment(appointment)"
            placeholder="Brief description of the visit purpose">
        </div>
        <div class="col-12">
          <label for="notes" class="form-label">Additional Notes</label>
          <textarea 
            id="notes" 
            class="form-control" 
            rows="3" 
            [(ngModel)]="editForm.notes" 
            name="notes"
            [disabled]="!canEditAppointment(appointment)"
            placeholder="Any additional information..."></textarea>
        </div>
      </div>

      <div class="mt-3" *ngIf="appointment">
        <div class="d-flex align-items-center">
          <span class="me-3">Current Status:</span>
          <span [ngClass]="getStatusBadgeClass(appointment.status)">
            {{ appointment.status | titlecase }}
          </span>
        </div>
      </div>

      <div class="mt-4 d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-secondary" (click)="goBack()">
          <i class="bi bi-arrow-left me-2"></i>
          Back to Appointments
        </button>
        <button 
          type="submit" 
          class="btn btn-primary" 
          [disabled]="isUpdating || !editFormRef.form.valid || !canEditAppointment(appointment)"
          *ngIf="canEditAppointment(appointment)">
          <span *ngIf="isUpdating" class="spinner-border spinner-border-sm me-2"></span>
          <i *ngIf="!isUpdating" class="bi bi-check-circle me-2"></i>
          {{ isUpdating ? 'Updating...' : 'Update Appointment' }}
        </button>
        <button 
          type="button" 
          class="btn btn-info" 
          *ngIf="!canEditAppointment(appointment)"
          disabled>
          <i class="bi bi-eye me-2"></i>
          View Only Mode
        </button>
      </div>
    </form>
  </div>

  <div *ngIf="!isLoading && !appointment" class="text-center">
    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
    <h4 class="mt-3">Appointment Not Found</h4>
    <p class="text-muted">The appointment you're looking for doesn't exist or has been removed.</p>
    <button type="button" class="btn btn-primary" (click)="goBack()">
      <i class="bi bi-arrow-left me-2"></i>
      Back to Appointments
    </button>
  </div>
</div>
