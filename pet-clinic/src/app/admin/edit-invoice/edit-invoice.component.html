<div class="container-fluid py-4">

  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="h4 mb-0">
            <i class="bi bi-pencil me-2"></i>
            Edit Invoice
          </h2>
          <p class="text-muted mb-0" *ngIf="invoice">
            Invoice #{{ invoice.invoice_number }}
          </p>
        </div>
        <div class="btn-group">
          <button 
            class="btn btn-outline-secondary" 
            (click)="goBack()"
            title="Go Back">
            <i class="bi bi-arrow-left me-1"></i>
            Back to Billing
          </button>
        </div>
      </div>
    </div>
  </div>


  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Loading invoice details...</p>
  </div>


  <div *ngIf="!isLoading && invoice" class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">
            <i class="bi bi-pencil me-2"></i>
            Invoice Information
          </h5>
        </div>
        <div class="card-body">
          <form #editFormTemplate="ngForm" novalidate>

            <div class="row mb-4">
              <div class="col-12">
                <h6 class="border-bottom pb-2 mb-3">
                  <i class="bi bi-person me-2"></i>
                  Patient Information
                </h6>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Patient Name *</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    [(ngModel)]="editForm.patient_name" 
                    name="patient_name" 
                    required
                    placeholder="Enter patient name">
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Patient Email *</label>
                  <input 
                    type="email" 
                    class="form-control" 
                    [(ngModel)]="editForm.patient_email" 
                    name="patient_email" 
                    required
                    placeholder="Enter patient email">
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Patient Phone *</label>
                  <input 
                    type="tel" 
                    class="form-control" 
                    [(ngModel)]="editForm.patient_phone" 
                    name="patient_phone" 
                    required
                    placeholder="Enter patient phone">
                </div>
              </div>
            </div>

            <div class="row mb-4">
              <div class="col-12">
                <h6 class="border-bottom pb-2 mb-3">
                  <i class="bi bi-heart me-2"></i>
                  Pet & Doctor Information
                </h6>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Pet Name</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    [(ngModel)]="editForm.pet_name" 
                    name="pet_name" 
                    placeholder="Enter pet name">
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Doctor *</label>
                  <select 
                    class="form-select" 
                    [(ngModel)]="editForm.doctor_name" 
                    name="doctor_name" 
                    required>
                    <option value="">Select Doctor</option>
                    <option *ngFor="let doctor of doctors" [value]="doctor.dname">
                      {{ doctor.dname }} - {{ doctor.specialization }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Service *</label>
                  <select 
                    class="form-select" 
                    [(ngModel)]="editForm.service_name" 
                    name="service_name" 
                    required>
                    <option value="">Select Service</option>
                    <option *ngFor="let service of services" [value]="service.name">
                      {{ service.name }} - {{ formatCurrency(service.price) }}
                    </option>
                  </select>
                </div>
              </div>
            </div>


            <div class="row mb-4">
              <div class="col-12">
                <h6 class="border-bottom pb-2 mb-3">
                  <i class="bi bi-gear me-2"></i>
                  Service Details
                </h6>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Service Description</label>
                  <textarea 
                    class="form-control" 
                    rows="3" 
                    [(ngModel)]="editForm.service_description" 
                    name="service_description" 
                    placeholder="Enter service description"></textarea>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Service Price (Rs.) *</label>
                  <input 
                    type="number" 
                    class="form-control" 
                    [(ngModel)]="editForm.service_price" 
                    name="service_price" 
                    required 
                    min="0" 
                    step="0.01" 
                    placeholder="Enter service price">
                </div>
              </div>
            </div>

            <div class="row mb-4">
              <div class="col-12">
                <h6 class="border-bottom pb-2 mb-3">
                  <i class="bi bi-calculator me-2"></i>
                  Financial Information
                </h6>
              </div>
              <!-- <div class="col-md-3">
                <div class="mb-3">
                  <label class="form-label">Additional Charges ($)</label>
                  <input 
                    type="number" 
                    class="form-control" 
                    [(ngModel)]="editForm.additional_charges" 
                    name="additional_charges" 
                    min="0" 
                    step="0.01" 
                    placeholder="0.00">
                </div>
              </div> -->
              <div class="col-md-3">
                <div class="mb-3">
                  <label class="form-label">Discount ($)</label>
                  <input 
                    type="number" 
                    class="form-control" 
                    [(ngModel)]="editForm.discount" 
                    name="discount" 
                    min="0" 
                    step="0.01" 
                    placeholder="0.00">
                </div>
              </div>
              <div class="col-md-3">
                <div class="mb-3">
                  <label class="form-label">Tax Rate (%)</label>
                  <select 
                    class="form-select" 
                    [(ngModel)]="editForm.tax_rate" 
                    name="tax_rate">
                    <option *ngFor="let rate of Object.keys(taxRates)" [value]="rate">
                      {{ rate }}% Tax
                    </option>
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <div class="mb-3">
                  <label class="form-label">Total Amount</label>
                  <div class="form-control-plaintext fw-bold text-success">
                    {{ formatCurrency(calculateTotal()) }}
                  </div>
                </div>
              </div>
            </div>

            <div class="row mb-4">
              <div class="col-12">
                <h6 class="border-bottom pb-2 mb-3">
                  <i class="bi bi-credit-card me-2"></i>
                  Payment Information
                </h6>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Payment Status</label>
                  <select 
                    class="form-select" 
                    [(ngModel)]="editForm.payment_status" 
                    name="payment_status">
                    <option *ngFor="let status of Object.values(PaymentStatus)" [value]="status">
                      {{ getPaymentStatusLabel(status) }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Payment Method</label>
                  <select 
                    class="form-select" 
                    [(ngModel)]="editForm.payment_method" 
                    name="payment_method">
                    <option value="">Select Payment Method</option>
                    <option *ngFor="let method of Object.values(PaymentMethod)" [value]="method">
                      {{ getPaymentMethodLabel(method) }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Due Date *</label>
                  <input 
                    type="date" 
                    class="form-control" 
                    [(ngModel)]="editForm.due_date" 
                    name="due_date" 
                    required>
                </div>
              </div>
            </div>

            <div class="row mb-4">
              <div class="col-12">
                <h6 class="border-bottom pb-2 mb-3">
                  <i class="bi bi-sticky me-2"></i>
                  Additional Notes
                </h6>
                <div class="mb-3">
                  <textarea 
                    class="form-control" 
                    rows="3" 
                    [(ngModel)]="editForm.notes" 
                    name="notes" 
                    placeholder="Enter any additional notes or comments"></textarea>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-12">
                <div class="d-flex justify-content-end gap-2">
                  <button 
                    type="button" 
                    class="btn btn-outline-secondary" 
                    (click)="goBack()">
                    <i class="bi bi-x-circle me-1"></i>
                    Cancel
                  </button>
                  <button 
                    type="button" 
                    class="btn btn-primary" 
                    (click)="updateInvoice()" 
                    [disabled]="isUpdating || editFormTemplate.invalid">
                    <span *ngIf="isUpdating" class="spinner-border spinner-border-sm me-2"></span>
                    <i class="bi bi-check-circle me-1" *ngIf="!isUpdating"></i>
                    {{ isUpdating ? 'Updating...' : 'Update Invoice' }}
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!isLoading && !invoice" class="text-center py-5">
    <div class="alert alert-danger">
      <i class="bi bi-exclamation-triangle me-2"></i>
      Invoice not found or failed to load.
    </div>
    <button class="btn btn-primary" (click)="goBack()">
      <i class="bi bi-arrow-left me-1"></i>
      Back to Billing
    </button>
  </div>
</div>
